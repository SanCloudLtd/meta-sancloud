# Copyright (C) 2021-2022 SanCloud Ltd
# SPDX-License-Identifier: MIT

name: CI
on: [push, pull_request]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Setup Python
        uses: actions/setup-python@v2

      - name: Run pre-commit checks
        uses: pre-commit/action@v2.0.3

  yocto-check-layer:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/sancloudltd/poky-build:dev
      options: --user 1001:121
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Restore layer cache
        uses: actions/cache@v2
        with:
          path: ${{ github.workspace }}/layers
          key: yocto-layer-cache

      - name: Checkout layer dependencies
        run: kas checkout --update --force-checkout kas/dev/bbe-poky.yml

      - name: Check layer compatibility
        run: |
          source layers/poky/oe-init-build-env build-checklayer
          yocto-check-layer .. \
              --machines qemux86-64 bbe \
              --dependency ../layers/{meta-arm/meta-arm,meta-arm/meta-arm-toolchain,meta-ti,meta-rtlwifi} \
              --no-auto-dependency --no-auto
