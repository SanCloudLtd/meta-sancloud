# Copyright (c) 2022 SanCloud Ltd
# SPDX-License-Identifier: MIT

stages:
  - build
  - finalize

.bsp_build:
  image: gitlab-registry.sancloud.co.uk/bsp/build-containers/poky-build:latest
  stage: build
  tags:
    - yocto
  cache:
    key: layers
    paths:
      - layers
  script:
    - ./scripts/maintainer.py build -i /mnt/cache/yocto/site.conf -s ${SERIES} -d ${DISTRO} -x ci

dunfell-poky-bbe:
  extends: .bsp_build
  variables:
    SERIES: dunfell
    DISTRO: poky

dunfell-arago-bbe:
  extends: .bsp_build
  image: gitlab-registry.sancloud.co.uk/bsp/build-containers/arago-build:latest
  variables:
    SERIES: dunfell
    DISTRO: arago

kirkstone-poky-bbe:
  extends: .bsp_build
  variables:
    SERIES: kirkstone
    DISTRO: poky

update-tracking-branches:
  only:
    - main
  stage: finalize
  image: gitlab-registry.sancloud.co.uk/bsp/build-containers/dev23-base:latest
  script:
    - git push --force origin HEAD:dunfell
    - git push --force origin HEAD:kirkstone
